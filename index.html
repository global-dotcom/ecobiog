<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에코바이오 정부지원사업 아카이브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .modal-active { overflow: hidden; }
        .custom-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .year-scroll::-webkit-scrollbar { height: 4px; }
        .year-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .year-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-900">

    <!-- App Shell -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Navigation -->
        <nav class="h-16 bg-white border-b px-6 flex items-center justify-between sticky top-0 z-40 shadow-sm">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                </div>
                <h1 class="text-lg font-bold tracking-tight">EcoBio <span class="text-indigo-600">Archive</span></h1>
            </div>
            <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition-transform active:scale-95 shadow-lg shadow-indigo-100">
                <i data-lucide="plus" class="w-4 h-4"></i> 신규 등록
            </button>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto w-full p-6 grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left: Dashboard -->
            <div class="lg:col-span-3 space-y-6">
                <div class="flex flex-col gap-4">
                    <div id="yearSelector" class="flex gap-2 p-1 bg-slate-100 rounded-xl overflow-x-auto year-scroll pb-2 lg:pb-1">
                        <!-- Years will be generated by JS -->
                    </div>
                </div>

                <div id="projectGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-full py-20 text-center text-slate-400 font-medium bg-white border-2 border-dashed rounded-3xl">
                        데이터를 불러오는 중입니다...
                    </div>
                </div>

                <!-- Bottom: Major Portals -->
                <div class="pt-8 border-t">
                    <h3 class="text-sm font-black text-slate-400 mb-4 flex items-center gap-2 uppercase tracking-widest">
                        <i data-lucide="link" class="w-4 h-4"></i> 주요 지원사업 포털
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                        <a href="https://www.bizinfo.go.kr" target="_blank" class="p-3 bg-white border rounded-xl text-xs font-bold text-center hover:border-indigo-400 hover:text-indigo-600 transition-all">기업마당</a>
                        <a href="https://www.k-startup.go.kr" target="_blank" class="p-3 bg-white border rounded-xl text-xs font-bold text-center hover:border-indigo-400 hover:text-indigo-600 transition-all">K-Startup</a>
                        <a href="https://www.iris.go.kr" target="_blank" class="p-3 bg-white border rounded-xl text-xs font-bold text-center hover:border-indigo-400 hover:text-indigo-600 transition-all">IRIS</a>
                        <a href="https://www.ntis.go.kr" target="_blank" class="p-3 bg-white border rounded-xl text-xs font-bold text-center hover:border-indigo-400 hover:text-indigo-600 transition-all">NTIS</a>
                        <a href="https://www.smtech.go.kr" target="_blank" class="p-3 bg-white border rounded-xl text-xs font-bold text-center hover:border-indigo-400 hover:text-indigo-600 transition-all">SMTECH</a>
                        <a href="https://www.rnd.or.kr" target="_blank" class="p-3 bg-white border rounded-xl text-xs font-bold text-center hover:border-indigo-400 hover:text-indigo-600 transition-all">산업기술R&D</a>
                    </div>
                </div>
            </div>

            <!-- Right: AI Recommendations -->
            <aside class="space-y-6">
                <div class="bg-slate-900 p-6 rounded-[2rem] shadow-xl text-white relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-500/20 rounded-full blur-2xl"></div>
                    <h3 class="font-bold flex items-center gap-2 mb-6 relative z-10">
                        <i data-lucide="sparkles" class="w-5 h-5 text-indigo-400"></i> AI 맞춤 공고 추천
                    </h3>
                    <div id="aiRecommendations" class="space-y-4 relative z-10">
                        <!-- AI Recommendations will be inserted here -->
                    </div>
                    <p class="mt-6 text-[10px] text-slate-500 font-bold border-t border-white/10 pt-4">
                        * 에코바이오의학연구소 업종 및 실적 기반 분석
                    </p>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modal Form -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-xl font-black text-slate-800">지원사업 정보 등록</h2>
                <button onclick="closeModal()" class="p-2 hover:bg-white rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <form id="projectForm" class="p-6 overflow-y-auto space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">사업명</label>
                        <input name="title" required class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold" placeholder="공고 명칭을 입력하세요">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">주관처</label>
                        <input name="agency" required class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold" placeholder="기관명">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">분야</label>
                        <select name="category" class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold cursor-pointer">
                            <option>연구과제</option>
                            <option>제조지원</option>
                            <option>마케팅</option>
                            <option>임상/인증</option>
                            <option>기타</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">주요내용</label>
                        <textarea name="content" rows="3" class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold" placeholder="핵심 내용 요약"></textarea>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">사업비</label>
                        <input name="cost" class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold" placeholder="예: 1.5억원">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">일정</label>
                        <input name="schedule" class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold" placeholder="예: ~05/20">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">진행현황</label>
                        <input name="progress" class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold" placeholder="예: 서류 접수중">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">상태</label>
                        <select name="status" class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold">
                            <option>대기</option>
                            <option>진행중</option>
                            <option>완료</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">공고 URL</label>
                        <input name="url" class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold" placeholder="https://...">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">비고</label>
                        <input name="note" class="w-full mt-1 px-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:border-indigo-500 outline-none font-bold" placeholder="특이사항 메모">
                    </div>
                </div>
                
                <div class="flex gap-4 pt-6 bg-white sticky bottom-0">
                    <select name="year" id="formYear" class="px-4 py-3 border-2 rounded-xl font-bold text-indigo-600 outline-none">
                        <!-- JS에서 동적 생성 -->
                    </select>
                    <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-[0.98]">
                        정보 저장하기
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // 초기화 및 전역 변수
        let currentYear = '2026';
        let db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ecobio-portal-v1';
        const years = ['2024', '2025', '2026', '2027', '2028', '2029'];

        const recommendations = [
            { title: "2026 해양 바이오 전략소재 기술개발", agency: "해양수산부", link: "https://www.mof.go.kr", dday: "D-12" },
            { title: "중소기업 기술혁신개발사업(수출지향형)", agency: "중소벤처기업부", link: "https://www.mss.go.kr", dday: "D-5" },
            { title: "바이오·의료기술개발사업(천연물 신약)", agency: "과학기술정보통신부", link: "https://www.msit.go.kr", dday: "D-20" },
            { title: "2026 글로벌 강소기업 육성사업", agency: "중기부", link: "https://www.bizinfo.go.kr", dday: "D-8" },
            { title: "기능성 화장품 소재 국산화 지원사업", agency: "보건복지부", link: "https://www.khidi.or.kr", dday: "D-15" }
        ];

        // 초기화 함수
        function init() {
            // 년도 선택기 생성
            const yearSelector = document.getElementById('yearSelector');
            yearSelector.innerHTML = years.map(y => `
                <button onclick="changeYear('${y}')" class="year-btn shrink-0 px-6 py-2 rounded-lg text-sm font-bold transition-all ${y === currentYear ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400 hover:text-slate-600'}" data-year="${y}">${y}년</button>
            `).join('');

            // 폼 년도 선택기 생성
            const formYear = document.getElementById('formYear');
            formYear.innerHTML = years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}년</option>`).join('');

            // 추천 리스트 생성
            const aiRecContainer = document.getElementById('aiRecommendations');
            aiRecContainer.innerHTML = recommendations.map(rec => `
                <a href="${rec.link}" target="_blank" class="block p-4 bg-white/5 hover:bg-white/10 border border-white/5 rounded-2xl transition-all group">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-black text-indigo-400 uppercase tracking-tighter">${rec.agency}</span>
                        <span class="text-[10px] font-bold text-rose-400">${rec.dday}</span>
                    </div>
                    <div class="text-sm font-bold text-slate-100 leading-snug group-hover:text-white">${rec.title}</div>
                </a>
            `).join('');

            lucide.createIcons();
        }

        // 모달 제어
        function openModal() {
            document.getElementById('modal').classList.remove('hidden');
            document.body.classList.add('modal-active');
            document.getElementById('formYear').value = currentYear;
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.body.classList.remove('modal-active');
            document.getElementById('projectForm').reset();
        }

        // 년도 변경
        function changeYear(year) {
            currentYear = year;
            document.querySelectorAll('.year-btn').forEach(btn => {
                if(btn.dataset.year === year) {
                    btn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                    btn.classList.add('text-slate-400');
                }
            });
            fetchProjects();
        }

        // 데이터 렌더링
        function renderProjects(projects) {
            const grid = document.getElementById('projectGrid');
            const filtered = projects.filter(p => p.year === currentYear);

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400 font-medium bg-white border-2 border-dashed rounded-[2.5rem]">등록된 ${currentYear}년 사업이 없습니다.</div>`;
                return;
            }

            grid.innerHTML = filtered.map(p => `
                <div class="bg-white border p-6 rounded-[2rem] hover:shadow-xl transition-all border-slate-100 relative group">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-[10px] font-black px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded-lg uppercase tracking-tight">${p.category}</span>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="deleteProject('${p.id}')" class="p-2 text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <h3 class="text-lg font-black text-slate-800 leading-tight mb-1">${p.title}</h3>
                    <p class="text-xs font-bold text-indigo-500 mb-5">${p.agency}</p>
                    
                    <div class="space-y-2 mb-6 text-[11px] font-bold">
                        <div class="flex justify-between"><span class="text-slate-400">사업비</span><span class="text-slate-700">${p.cost || '-'}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">일정</span><span class="text-slate-700">${p.schedule || '-'}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">현황</span><span class="text-slate-700">${p.progress || '-'}</span></div>
                    </div>

                    <div class="flex items-center justify-between pt-4 border-t border-slate-50">
                        <span class="text-[10px] font-black px-3 py-1 rounded-full ${p.status === '완료' ? 'bg-emerald-50 text-emerald-600' : 'bg-amber-50 text-amber-600'}">${p.status}</span>
                        ${p.url ? `<a href="${p.url}" target="_blank" class="p-2 bg-slate-50 rounded-full text-slate-400 hover:text-indigo-600 transition-all"><i data-lucide="external-link" class="w-4 h-4"></i></a>` : ''}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Firebase 로직
        async function fetchProjects() {
            if(!db) return;
            const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('projects');
            colRef.onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjects(data);
            });
        }

        async function deleteProject(id) {
            if(!confirm('정말 삭제하시겠습니까?')) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('projects').doc(id).delete();
        }

        // 초기 실행
        window.onload = async () => {
            init();
            
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                db = firebase.firestore();

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }

                fetchProjects();

                // 폼 제출 이벤트
                document.getElementById('projectForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('projects').add(data);
                    closeModal();
                };

            } catch (err) {
                console.error("Initialization Failed:", err);
                document.getElementById('projectGrid').innerHTML = '<div class="col-span-full py-10 text-center text-rose-500 font-bold">인증에 실패했습니다. 다시 시도해주세요.</div>';
            }
        };
    </script>
</body>
</html>